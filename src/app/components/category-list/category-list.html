<div class="category-container">
  <div class="header-section">
    <h1 class="page-title">Kategoriler</h1>
    <button mat-flat-button color="primary" (click)="openAddModal()">
      <mat-icon>add</mat-icon>
      Yeni Kategori Ekle
    </button>
  </div>

  <!-- Search Bar -->
  <div class="search-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Ara</mat-label>
      <input 
        matInput 
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
        placeholder="Kategori adına göre ara...">
      <mat-icon matPrefix>search</mat-icon>
      @if (searchTerm()) {
        <button mat-icon-button matSuffix (click)="clearSearch()" aria-label="Temizle">
          <mat-icon>clear</mat-icon>
        </button>
      }
    </mat-form-field>
  </div>

  <!-- Loading State -->
  @if (loading() && initialLoad()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Kategoriler yükleniyor...</p>
    </div>
  }


  <!-- Categories Table -->
  @if (!initialLoad() || categories().length > 0) {
    <div class="table-wrapper" [class.loading-overlay]="loading() && !initialLoad()">
      @if (loading() && !initialLoad()) {
        <div class="table-loading-overlay">
          <mat-spinner diameter="30"></mat-spinner>
        </div>
      }

      <table mat-table [dataSource]="categories()" class="mat-elevation-z2">
        <!-- No Column -->
        <ng-container matColumnDef="no">
          <th mat-header-cell *matHeaderCellDef class="no-header">No</th>
          <td mat-cell *matCellDef="let category; let i = index" class="no-cell">
            {{ (currentPage() - 1) * pageSize() + i + 1 }}
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef (click)="onSortChange('name')">
            Kategori Adı
            @if (currentSort().active === 'name') {
              <mat-icon class="sort-icon">
                {{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            }
          </th>
          <td mat-cell *matCellDef="let category" class="name-cell">{{ category.name }}</td>
        </ng-container>

        <!-- Created Date Column -->
        <ng-container matColumnDef="createdDate">
          <th mat-header-cell *matHeaderCellDef (click)="onSortChange('createdDate')">
            Oluşturulma Tarihi
            @if (currentSort().active === 'createdDate') {
              <mat-icon class="sort-icon">
                {{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            }
          </th>
          <td mat-cell *matCellDef="let category" class="date-cell">
            {{ category.createdDate | date: 'dd.MM.yyyy HH:mm' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">İşlemler</th>
          <td mat-cell *matCellDef="let category" class="actions-cell">
            <button 
              mat-icon-button 
              [matMenuTriggerFor]="menu"
              (click)="$event.stopPropagation()"
              matTooltip="İşlemler">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openEditModalFromDropdown(category)">
                <mat-icon>edit</mat-icon>
                <span>Düzenle</span>
              </button>
              <button mat-menu-item (click)="deleteCategory(category.id, category.name)">
                <mat-icon>delete</mat-icon>
                <span>Sil</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <!-- Pagination -->
      @if (pagedResponse()) {
        <mat-paginator
          [length]="pagedResponse()!.totalCount"
          [pageSize]="pageSize()"
          [pageIndex]="currentPage() - 1"
          [pageSizeOptions]="[9, 15, 30, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      }
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && categories().length === 0) {
    <div class="empty-container">
      <mat-icon class="empty-icon">folder_open</mat-icon>
      <p>Henüz kategori bulunmamaktadır.</p>
    </div>
  }

  <!-- Modal Dialog -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 mat-dialog-title>{{ isEditMode() ? 'Kategori Düzenle' : 'Yeni Kategori Ekle' }}</h2>
          <button mat-icon-button (click)="closeModal()" class="close-button">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()" class="modal-body">

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Kategori Adı</mat-label>
            <input matInput formControlName="name" placeholder="Kategori adını girin" required>
            @if (categoryForm.get('name')?.hasError('required') && categoryForm.get('name')?.touched) {
              <mat-error>Kategori adı zorunludur</mat-error>
            }
            @if (categoryForm.get('name')?.hasError('minlength') && categoryForm.get('name')?.touched) {
              <mat-error>Kategori adı en az 2 karakter olmalıdır</mat-error>
            }
            @if (categoryForm.get('name')?.hasError('maxlength') && categoryForm.get('name')?.touched) {
              <mat-error>Kategori adı en fazla 100 karakter olabilir</mat-error>
            }
          </mat-form-field>

          <div class="modal-footer">
            <button mat-button type="button" (click)="closeModal()" [disabled]="formSubmitting()">
              İptal
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              type="submit" 
              [disabled]="categoryForm.invalid || formSubmitting()">
              @if (formSubmitting()) {
                <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
              }
              {{ isEditMode() ? 'Güncelle' : 'Ekle' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
